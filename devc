#!/bin/bash

if [[ ! -e .devcontainer ]]; then
  echo this repository does not have devcontainer configuration file.
  exit 1
fi

DEVC_JSON=$(cat .devcontainer/devcontainer.json | strip-json-comments)
SERVICE_NAME=$(echo $DEVC_JSON | jq -r .service)
WORKDIR_NAME=$(basename $(pwd))

DEVCONTAINER_SSH_AUTH_SOCK=/tmp/devcontainer-ssh-auth-sock
ln -f ${SSH_AUTH_SOCK} ${DEVCONTAINER_SSH_AUTH_SOCK}

OVERRIDE_COMPOSE_NAME="override-compose.yaml"
cat <<EOF > .devcontainer/${OVERRIDE_COMPOSE_NAME}
# generated by devcli. don't edit this file
version: '3'
services:
  ${SERVICE_NAME}:
    volumes:
      - ..:/workspaces/${WORKDIR_NAME}
      - ${DEVCONTAINER_SSH_AUTH_SOCK}:/home/vscode/.ssh-auth-sock
      - ${HOME}/.aws:/home/vscode/.aws
    environment:
      SSH_AUTH_SOCK: /home/vscode/.ssh-auth-sock
EOF

echo ${DEVC_JSON} | jq ".dockerComposeFile += [\"${OVERRIDE_COMPOSE_NAME}\"]" > .devcontainer/devcontainer_mod.json

DEVCONTAINER_FLAGS=""
if [[ ! -z $(docker ps -f name=${WORKDIR_NAME}_devcontainer-${SERVICE_NAME}-1 -q) ]]; then
  DEVCONTAINER_FLAGS="--expect-existing-container=true "
fi
REMOVE_FLAG=""
if [ "$1" = "true" ]; then
    REMOVE_FLAG="--remove-existing-container"
fi

devcontainer up ${DEVCONTAINER_FLAGS} ${REMOVE_FLAG} \
  --override-config .devcontainer/devcontainer_mod.json
